<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الإعدادات - Shipsy Econnect</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.rtl.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      .settings-container {
        padding: 20px;
      }

      .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
      }

      .form-section {
        margin-bottom: 30px;
      }

      .alert-success {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="settings-container">
      <!-- Navigation -->
      <nav
        class="navbar navbar-expand-lg navbar-dark bg-dark mb-4"
        style="
          background: linear-gradient(
            135deg,
            #667eea 0%,
            #764ba2 100%
          ) !important;
        "
      >
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <i class="fa fa-ship"></i> Shipsy Econnect
          </a>
          <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/admin">لوحة التحكم</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/admin/settings">الإعدادات</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Page Title -->
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="text-white mb-2">الإعدادات</h1>
        </div>
      </div>

      <!-- Alerts -->
      <div class="row mb-4">
        <div class="col-12">
          <div
            class="alert alert-success alert-dismissible fade show"
            id="success-alert"
            role="alert"
          >
            تم تحديث الإعدادات بنجاح
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          <div
            class="alert alert-danger alert-dismissible fade show"
            id="error-alert"
            role="alert"
          >
            <span id="error-message">حدث خطأ</span>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
        </div>
      </div>

      <!-- Settings Form -->
      <form id="settings-form">
        <!-- Shipsy Settings -->
        <div class="row mb-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">إعدادات Shipsy</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">مفتاح API</label>
                  <input
                    type="password"
                    class="form-control"
                    id="shipsy-api-key"
                    placeholder="أدخل مفتاح API"
                  />
                  <small class="text-muted"
                    >يتم تخزينه بأمان ولا يتم عرضه</small
                  >
                </div>
                <div class="mb-3">
                  <label class="form-label">اسم المنظمة</label>
                  <input
                    type="text"
                    class="form-control"
                    id="shipsy-org"
                    placeholder="أدخل اسم المنظمة"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">عنوان API</label>
                  <input
                    type="url"
                    class="form-control"
                    id="shipsy-url"
                    placeholder="https://api.shipsy.io"
                  />
                </div>
                <button
                  type="button"
                  class="btn btn-info"
                  onclick="testConnection()"
                >
                  <i class="fa fa-plug"></i> اختبار الاتصال
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Store Settings -->
        <div class="row mb-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">بيانات المتجر</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label">اسم المتجر</label>
                  <input
                    type="text"
                    class="form-control"
                    id="store-name"
                    placeholder="اسم متجرك"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">رقم الهاتف</label>
                  <input
                    type="tel"
                    class="form-control"
                    id="store-phone"
                    placeholder="+966..."
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">العنوان (السطر الأول)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="store-address1"
                    placeholder="الشارع والحي"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">العنوان (السطر الثاني)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="store-address2"
                    placeholder="تفاصيل إضافية"
                  />
                </div>
                <div class="mb-3">
                  <label class="form-label">الرمز البريدي</label>
                  <input
                    type="text"
                    class="form-control"
                    id="store-pincode"
                    placeholder="الرمز البريدي"
                  />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sync Settings -->
        <div class="row mb-4">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">إعدادات المزامنة</h5>
              </div>
              <div class="card-body">
                <div class="mb-3 form-check">
                  <input
                    type="checkbox"
                    class="form-check-input"
                    id="auto-sync-enabled"
                  />
                  <label class="form-check-label" for="auto-sync-enabled">
                    تفعيل المزامنة التلقائية
                  </label>
                  <small class="d-block text-muted mt-2"
                    >سيتم مزامنة الطلبات الجديدة تلقائياً عند إنشاؤها</small
                  >
                </div>
                <div class="mb-3">
                  <label class="form-label">جدول مزامنة الطلبات (Cron)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="sync-interval"
                    value="*/15 * * * *"
                    placeholder="*/15 * * * *"
                  />
                  <small class="text-muted">*/15 * * * * = كل 15 دقيقة</small>
                </div>
                <div class="mb-3">
                  <label class="form-label">جدول تحديث الحالة (Cron)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="status-interval"
                    value="0 * * * *"
                    placeholder="0 * * * *"
                  />
                  <small class="text-muted">0 * * * * = كل ساعة</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
          <div class="col-lg-8">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fa fa-save"></i> حفظ الإعدادات
            </button>
            <button
              type="button"
              class="btn btn-secondary btn-lg"
              onclick="resetForm()"
            >
              <i class="fa fa-undo"></i> إعادة تعيين
            </button>
          </div>
        </div>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // تحميل الإعدادات
      async function loadSettings() {
        try {
          const response = await fetch("/api/settings");
          const result = await response.json();

          if (result.success) {
            const data = result.data;
            document.getElementById("shipsy-org").value =
              data.shipsy?.organisation || "";
            document.getElementById("shipsy-url").value =
              data.shipsy?.baseUrl || "";
            document.getElementById("store-name").value =
              data.store?.name || "";
            document.getElementById("store-phone").value =
              data.store?.phone || "";
            document.getElementById("store-address1").value =
              data.store?.address?.line1 || "";
            document.getElementById("store-address2").value =
              data.store?.address?.line2 || "";
            document.getElementById("store-pincode").value =
              data.store?.address?.pincode || "";
            document.getElementById("auto-sync-enabled").checked =
              data.sync?.enableAutoSync !== false;
            document.getElementById("sync-interval").value =
              data.sync?.syncInterval || "*/15 * * * *";
            document.getElementById("status-interval").value =
              data.sync?.statusUpdateInterval || "0 * * * *";
          }
        } catch (error) {
          showError("فشل تحميل الإعدادات: " + error.message);
        }
      }

      // حفظ الإعدادات
      document
        .getElementById("settings-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const settings = {
            shipsy: {
              organisation: document.getElementById("shipsy-org").value,
              baseUrl: document.getElementById("shipsy-url").value,
            },
            store: {
              name: document.getElementById("store-name").value,
              phone: document.getElementById("store-phone").value,
              address: {
                line1: document.getElementById("store-address1").value,
                line2: document.getElementById("store-address2").value,
                pincode: document.getElementById("store-pincode").value,
              },
            },
            sync: {
              enableAutoSync:
                document.getElementById("auto-sync-enabled").checked,
              syncInterval: document.getElementById("sync-interval").value,
              statusUpdateInterval:
                document.getElementById("status-interval").value,
            },
          };

          try {
            const response = await fetch("/api/settings", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ settings }),
            });

            const result = await response.json();

            if (result.success) {
              showSuccess("تم حفظ الإعدادات بنجاح");
            } else {
              showError("فشل حفظ الإعدادات: " + result.error);
            }
          } catch (error) {
            showError("حدث خطأ: " + error.message);
          }
        });

      // اختبار الاتصال
      async function testConnection() {
        try {
          const response = await fetch("/api/settings/test-connection", {
            method: "POST",
          });

          const result = await response.json();

          if (result.success) {
            alert("✅ تم الاتصال بنجاح!");
          } else {
            alert("❌ فشل الاتصال: " + result.message);
          }
        } catch (error) {
          alert("❌ خطأ: " + error.message);
        }
      }

      // إظهار رسالة النجاح
      function showSuccess(message) {
        const alert = document.getElementById("success-alert");
        alert.textContent = message;
        alert.style.display = "block";
        setTimeout(() => (alert.style.display = "none"), 5000);
      }

      // إظهار رسالة الخطأ
      function showError(message) {
        const alert = document.getElementById("error-alert");
        document.getElementById("error-message").textContent = message;
        alert.style.display = "block";
        setTimeout(() => (alert.style.display = "none"), 5000);
      }

      // إعادة تعيين النموذج
      function resetForm() {
        loadSettings();
      }

      // تحميل الإعدادات عند فتح الصفحة
      window.addEventListener("DOMContentLoaded", loadSettings);
    </script>
  </body>
</html>
